# PaddleOCR Skill 部署说明

> 让无视觉能力的大模型（如 GLM-4.7）也能"看"图片

## 背景问题

OpenWork 中的部分大模型（如智谱 GLM-4.7）本身无法识别图片。即使使用现有的 pdf/pptx skills，这些模型也看不到图像内容。

**解决方案**：部署本地 OCR 模型，先提取图片中的文字，再传给主模型分析。

---

## 技术选型

### 为什么选择 PaddleOCR？

| 特性 | 说明 |
|------|------|
| **引擎** | 原生 PaddleOCR Python (PP-OCRv5) |
| **语言支持** | 100+ 种语言 |
| **识别能力** | 文本、表格、公式、图表 |
| **运行环境** | CPU (macOS 完美支持) |
| **模型管理** | 自动下载，无需手动配置 |

### 方案对比

| 方案 | 优点 | 缺点 |
|------|------|------|
| **原生 PaddleOCR (当前)** | 稳定、功能完整、自动管理模型 | 首次运行需下载模型 |
| Ollama + PaddleOCR-VL | 统一 API | 模型兼容性问题 |

---

## 工作原理

```
┌─────────────┐     ┌──────────────────┐     ┌─────────────────┐
│ 用户输入    │     │ PaddleOCR        │     │ 主模型          │
│ (图片/PDF)  │────▶│ (本地 Python)    │────▶│ (GLM-4.7等)     │
│             │     │ 提取文字         │     │ 分析处理        │
└─────────────┘     └──────────────────┘     └─────────────────┘
```

### 调用流程

1. 用户提供图片或 PDF 路径
2. `ocr.py` 加载 PaddleOCR 模型（首次运行自动下载）
3. 对图片进行文字识别（支持多语言、表格、公式）
4. 返回提取的文本
5. 将文本传给主模型进行分析

---

## 完整复现步骤

### 前置条件

- macOS (Apple Silicon 或 Intel)
- Python 3.8 - 3.12
- Homebrew（用于安装 poppler）

### 第一步：安装 Python 依赖

```bash
# 核心依赖
pip install paddleocr paddlepaddle

# PDF 支持
pip install pdf2image
brew install poppler
```

### 第二步：创建 Skill 目录

```bash
# OpenWork 的 Skills 目录位置
SKILLS_DIR=~/Library/Application\ Support/com.differentai.openwork/workspaces/starter/.opencode/skills

# 方式1：从 GitHub 克隆
cd "$SKILLS_DIR"
git clone https://github.com/mr-shaper/opencode-skills-paddle-ocr.git paddle-ocr

# 方式2：手动创建
mkdir -p "$SKILLS_DIR/paddle-ocr/scripts"
```

### 第三步：验证安装

```bash
cd "$SKILLS_DIR/paddle-ocr"
python3 scripts/setup_check.py
```

### 第四步：测试 OCR

```bash
# 测试图片 OCR（首次运行会自动下载模型）
python3 scripts/ocr.py 测试图片.png

# 测试 PDF OCR
python3 scripts/ocr.py 测试文档.pdf
```

---

## 目录结构说明

### OpenWork Skills 正确位置

```
~/Library/Application Support/com.differentai.openwork/
└── workspaces/
    └── starter/
        └── .opencode/
            └── skills/           ← 所有 Skills 在这里
                ├── paddle-ocr/   ← OCR Skill
                ├── pdf/
                ├── pptx/
                └── ...
```

### Skill 文件结构

```
paddle-ocr/
├── SKILL.md              # Skill 主文档
├── README.md             # GitHub 说明
├── 部署说明.md            # 本文档
├── .gitignore
├── .env.example
└── scripts/
    ├── ocr.py            # 核心 OCR 脚本
    ├── setup_check.py    # 环境检查
    └── requirements.txt  # Python 依赖
```

### 备份位置（iCloud）

```
~/Library/Mobile Documents/com~apple~CloudDocs/AI/OPENWORK/Opencode Skills/paddle-ocr/
```

---

## 使用示例

### 基础用法

```bash
cd paddle-ocr

# 图片 OCR
python3 scripts/ocr.py /path/to/image.png

# PDF OCR（自动处理多页）
python3 scripts/ocr.py /path/to/document.pdf

# 指定语言
python3 scripts/ocr.py image.png --lang en      # 英文
python3 scripts/ocr.py image.png --lang ch      # 中英文（默认）
python3 scripts/ocr.py image.png --lang japan   # 日文

# 输出为 JSON
python3 scripts/ocr.py image.png --json > result.json

# 保存到文件
python3 scripts/ocr.py doc.pdf --output extracted.txt
```

### 在代码中集成

```python
import subprocess
import json

# 调用 OCR
result = subprocess.run(
    ["python3", "scripts/ocr.py", "chart.png", "--json"],
    capture_output=True, text=True,
    cwd="/path/to/paddle-ocr"
)

# 解析结果
ocr_data = json.loads(result.stdout)
extracted_text = ocr_data["text"]

# 构建增强提示词，传给主模型
prompt = f"""
以下是从图片中提取的内容：

{extracted_text}

请分析这些数据并给出见解。
"""
```

---

## 资源占用分析

### 模型文件

| 组件 | 大小 | 位置 |
|------|------|------|
| PP-OCRv5 检测模型 | ~50MB | `~/.paddlex/official_models/` |
| PP-OCRv5 识别模型 | ~100MB | `~/.paddlex/official_models/` |
| 方向分类模型 | ~10MB | `~/.paddlex/official_models/` |
| **总计** | **~200MB** | 首次运行自动下载 |

### 运行时资源

| 状态 | CPU | 内存 | 说明 |
|------|-----|------|------|
| **空闲时** | 0% | 0 | 不占用资源（按需加载） |
| **首次加载** | 高 | ~500MB | 加载模型到内存 |
| **推理时** | 中-高 | ~500MB-1GB | 处理图片时 |
| **处理完成** | 0% | 可释放 | 脚本退出后释放 |

### 性能预期 (Apple Silicon Mac)

| 场景 | 预期时间 |
|------|----------|
| 首次运行（下载模型） | 1-3 分钟 |
| 模型加载 | 3-5 秒 |
| 简单文本图片 | 1-3 秒 |
| 复杂表格图片 | 3-8 秒 |
| 单页 PDF | 5-10 秒 |
| 10 页 PDF | 1-2 分钟 |

---

## 常见问题

### Q: 首次运行很慢？

首次运行需要从 HuggingFace 下载模型（约 200MB），之后会使用缓存。

```bash
# 模型缓存位置
ls ~/.paddlex/official_models/
```

### Q: 网络问题无法下载模型？

设置环境变量跳过连接检查（使用已缓存的模型）：

```bash
export PADDLE_PDX_DISABLE_MODEL_SOURCE_CHECK=True
python3 scripts/ocr.py image.png
```

### Q: PDF 处理失败？

```bash
# 确保 poppler 已安装
brew install poppler

# 确保 pdf2image 已安装
pip install pdf2image
```

### Q: 如何切换语言？

```bash
# 支持的语言代码
python3 scripts/ocr.py image.png --lang ch      # 中英文
python3 scripts/ocr.py image.png --lang en      # 英文
python3 scripts/ocr.py image.png --lang japan   # 日文
python3 scripts/ocr.py image.png --lang korean  # 韩文
python3 scripts/ocr.py image.png --lang french  # 法文
python3 scripts/ocr.py image.png --lang german  # 德文
```

### Q: 如何清理模型缓存？

```bash
# 删除所有缓存的模型（约 200MB）
rm -rf ~/.paddlex/official_models/
```

---

## 与旧版 Ollama 方案的区别

| 对比项 | 旧版 (Ollama) | 新版 (原生 Python) |
|--------|---------------|-------------------|
| 依赖 | Ollama + 模型 | paddleocr + paddlepaddle |
| 模型管理 | 手动 pull | 自动下载 |
| 稳定性 | 有兼容问题 | 稳定 |
| 模型大小 | 935MB | ~200MB |
| 后台服务 | 需要 Ollama 服务 | 不需要 |

---

## 相关资源

- [PaddleOCR GitHub](https://github.com/PaddlePaddle/PaddleOCR)
- [PaddleOCR 官方文档](https://paddlepaddle.github.io/PaddleOCR/)
- [本项目 GitHub](https://github.com/mr-shaper/opencode-skills-paddle-ocr)

---

*最后更新: 2026-02-03*
